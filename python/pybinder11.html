<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>1. Pybind11实现Python与C++无缝连接 &mdash; Program 1.0 文档</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="prev" title="1. Qt Basic" href="../qt/qt_basic.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Program
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">Git</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../git/git_work.html">1. Git work with Github</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Qt Technology</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../qt/qt_basic.html">1. Qt Basic</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python Technology</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. Pybind11实现Python与C++无缝连接</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pybind11">1.1. Pybind11用途</a></li>
<li class="toctree-l2"><a class="reference internal" href="#windows">1.2. Windows 安装与设置</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">1.2.1. 测试</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#linux">1.3. Linux安装与配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="#c-python">1.4. C++与Python交互</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#python">1.4.1. Python类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="#numpy">1.4.2. Numpy</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Program</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">1. </span>Pybind11实现Python与C++无缝连接</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/python/pybinder11.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="pybind11pythonc">
<h1><span class="section-number">1. </span>Pybind11实现Python与C++无缝连接<a class="headerlink" href="#pybind11pythonc" title="此标题的永久链接"></a></h1>
<section id="pybind11">
<h2><span class="section-number">1.1. </span>Pybind11用途<a class="headerlink" href="#pybind11" title="此标题的永久链接"></a></h2>
<p>​	主要用于C++和python之间的相互调用是一轻量级仅标头库，语法类似Boost.Python使用编译时自动推断类型剥离了与绑定生成无关的所有内容，超越Boost.Python，简化了绑定代码。</p>
</section>
<section id="windows">
<h2><span class="section-number">1.2. </span>Windows 安装与设置<a class="headerlink" href="#windows" title="此标题的永久链接"></a></h2>
<p>  1. Windows系统</p>
<p>  Microsoft Visaul Studio 2017 x64，Anaconda3 , with python 3.8</p>
<p>  2. Pybind11安装</p>
<p>  pybind11是 header-only的，因此不需要编译动态链接库，直接使用即可。</p>
<p>  1）下载pybind11 https://github.com/pybind/pybind11解压到C:\pybind11-master；</p>
<p>  2）环境变量添加：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">C</span><span class="p">:</span>\<span class="n">ProgramData</span>\<span class="n">Anaconda3</span><span class="p">;</span>
  <span class="n">C</span><span class="p">:</span>\<span class="n">ProgramData</span>\<span class="n">Anaconda3</span>\<span class="n">Library</span>\<span class="n">mingw</span><span class="o">-</span><span class="n">w64</span>\<span class="nb">bin</span><span class="p">;</span>
  <span class="n">C</span><span class="p">:</span>\<span class="n">ProgramData</span>\<span class="n">Anaconda3</span>\<span class="n">Library</span>\<span class="n">usr</span>\<span class="nb">bin</span><span class="p">;</span>
  <span class="n">C</span><span class="p">:</span>\<span class="n">ProgramData</span>\<span class="n">Anaconda3</span>\<span class="n">Library</span>\<span class="nb">bin</span><span class="p">;</span>
  <span class="n">C</span><span class="p">:</span>\<span class="n">ProgramData</span>\<span class="n">Anaconda3</span>\<span class="n">Scripts</span><span class="p">;</span>
  <span class="n">C</span><span class="p">:</span>\<span class="n">ProgramData</span>\<span class="n">Anaconda3</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span><span class="p">;</span>
  <span class="n">C</span><span class="p">:</span>\<span class="n">ProgramData</span>\<span class="n">Anaconda3</span>\<span class="n">Lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">numpy</span>\<span class="n">core</span>\<span class="n">include</span><span class="p">;</span>
  <span class="n">C</span><span class="p">:</span>\<span class="n">ProgramData</span>\<span class="n">Anaconda3</span>\<span class="n">pkgs</span>\<span class="n">mkl</span><span class="o">-</span><span class="mf">2020.0</span><span class="o">-</span><span class="mi">166</span>\<span class="n">Library</span>\<span class="nb">bin</span><span class="p">;</span>
  <span class="n">C</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">Files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span>\<span class="n">Microsoft</span> <span class="n">Visual</span> <span class="n">Studio</span>\<span class="mi">2017</span>\<span class="n">Enterprise</span>\<span class="n">VC</span>\<span class="n">Tools</span>\<span class="n">MSVC</span>\<span class="mf">14.16.27023</span>\<span class="nb">bin</span>\<span class="n">Hostx64</span>\<span class="n">x64</span><span class="p">;</span>
  <span class="n">C</span><span class="p">:</span>\<span class="n">pybind11</span><span class="o">-</span><span class="n">master</span>\<span class="n">include</span><span class="p">;</span>  
</pre></div>
</div>
<p>  3）windows下python环境变量设置</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  Admin用户变量：`PYTHONHOME  C:\ProgramData\Anaconda3`
                               ` PYTHONPATH  C:\ProgramData\Anaconda3\Lib\site-packages `
</pre></div>
</div>
<p>  3.  使用VS2017测试</p>
<p>   使用C++编写python扩展（python调用C++）新建一个vs c++工程 example</p>
<p>   工程配置：</p>
<p>   1）设置编译输出类型</p>
<p>  配置属性–常规–常规–目标文件扩展名：.pyd</p>
<p>  配置属性–常规–项目默认值-配置类型：动态库.dll</p>
<p>   2）添加include包含：</p>
<p>  配置属性–VC++目录–常规–包含目录：<code class="docutils literal notranslate"><span class="pre">C:\pybind11-master\include</span></code>,<code class="docutils literal notranslate"><span class="pre">C:\ProgramData\Anaconda3\include</span></code></p>
<p>   3）链接器配置：</p>
<p>  链接器-常规-附加库目录：<code class="docutils literal notranslate"><span class="pre">C:\ProgramData\Anaconda3\libs</span></code>; 链接器-输入-附加依赖项：<code class="docutils literal notranslate"><span class="pre">python3.lib</span></code></p>
<p>  文件内容：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">example1</span><span class="o">.</span><span class="n">h</span>
		<span class="c1">#pragma once</span>
		<span class="nb">int</span> <span class="n">sub</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">example1</span><span class="o">.</span><span class="n">cpp</span>
		<span class="c1">#include &quot;example1.h&quot;</span>
 
		<span class="nb">int</span> <span class="n">sub</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">example</span><span class="o">.</span><span class="n">cpp</span>
		<span class="c1">#include &lt;pybind11/pybind11.h&gt;</span>
		<span class="c1">#include &quot;example1.h&quot;</span>
 
		<span class="n">namespace</span> <span class="n">py</span> <span class="o">=</span> <span class="n">pybind11</span><span class="p">;</span>
 
		<span class="nb">int</span> <span class="n">add</span><span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="nb">int</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">;}</span>
 
		<span class="n">PYBIND11_MODULE</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">.</span><span class="n">doc</span><span class="p">()</span> <span class="o">=</span> <span class="s2">&quot;pybind11 example plugin&quot;</span><span class="p">;</span> <span class="o">//</span> <span class="n">optional</span> <span class="n">module</span> <span class="n">docstring</span>
			<span class="n">m</span><span class="o">.</span><span class="n">def</span><span class="p">(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add</span><span class="p">,</span> <span class="s2">&quot;A function which adds two numbers&quot;</span><span class="p">);</span>
			<span class="n">m</span><span class="o">.</span><span class="n">def</span><span class="p">(</span><span class="s2">&quot;sub&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sub</span><span class="p">,</span> <span class="s2">&quot;A function which adds two numbers&quot;</span><span class="p">);</span>
		<span class="p">}</span>
</pre></div>
</div>
<section id="id1">
<h3><span class="section-number">1.2.1. </span>测试<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h3>
<p>在<code class="docutils literal notranslate"><span class="pre">example.pyd</span></code>目录下，执行以下python语句。</p>
<p><code class="docutils literal notranslate"><span class="pre">&gt;&gt;import</span> <span class="pre">example</span> <span class="pre">as</span> <span class="pre">ex</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">&gt;&gt;ex.add(2,3)</span></code></p>
</section>
</section>
<section id="linux">
<h2><span class="section-number">1.3. </span>Linux安装与配置<a class="headerlink" href="#linux" title="此标题的永久链接"></a></h2>
<ol class="arabic simple">
<li><p>python安装： <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">pybind11</span></code></p></li>
</ol>
<ol class="arabic" start="2">
<li><p>编译cpp文件：<code class="docutils literal notranslate"><span class="pre">c++</span> <span class="pre">-O3</span> <span class="pre">-Wall</span> <span class="pre">-shared</span> <span class="pre">-std=c++11</span> <span class="pre">-fPIC</span> <span class="pre">$(python3</span> <span class="pre">-m</span> <span class="pre">pybind11</span> <span class="pre">--includes)</span> <span class="pre">example.cpp</span> <span class="pre">-o</span> <span class="pre">example.so</span></code></p>
<p>如果使用IDE编写cpp文件，可以把<code class="docutils literal notranslate"><span class="pre">python3</span> <span class="pre">-m</span> <span class="pre">pybind11</span> <span class="pre">--includes</span></code>输出的路径添加到include路径，这样IDE就能智能代码提示。</p>
</li>
<li><p>python测试：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt;import example as ex</span>
<span class="go">&gt;&gt;&gt;ex.add(2,3)</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="c-python">
<h2><span class="section-number">1.4. </span>C++与Python交互<a class="headerlink" href="#c-python" title="此标题的永久链接"></a></h2>
<section id="python">
<h3><span class="section-number">1.4.1. </span>Python类型<a class="headerlink" href="#python" title="此标题的永久链接"></a></h3>
<ol class="arabic">
<li><p>有效的包裹类(Available wrappers)</p>
<p>所有的Python类型都使用C++包裹类进行包裹。这些类可以直接当作函数的参数。有效的类型有，</p>
<p><code class="docutils literal notranslate"><span class="pre">handle,</span> <span class="pre">object,</span> <span class="pre">bool_,</span> <span class="pre">int_,</span> <span class="pre">float_,</span> <span class="pre">str,</span> <span class="pre">bytes,</span> <span class="pre">tuple,</span> <span class="pre">list,</span> <span class="pre">dict,</span> <span class="pre">slice,</span> <span class="pre">none,</span> <span class="pre">capsule,</span> <span class="pre">iterable,</span> <span class="pre">iterator,</span> <span class="pre">function,</span> <span class="pre">buffer,</span> <span class="pre">array,</span> <span class="pre">array_t</span></code></p>
</li>
<li><p>示例</p>
<p>Python的字典类型可以在<code class="docutils literal notranslate"><span class="pre">dict</span></code>构造函数中进行初使化。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">namesapce</span><span class="w"> </span><span class="n">pybind11</span><span class="o">::</span><span class="n">literatls</span><span class="p">;</span><span class="w"> </span><span class="c1">//to bring in the  &#39;_a&#39; literal</span>
<span class="n">py</span><span class="o">::</span><span class="n">dict</span><span class="w"> </span><span class="n">d</span><span class="p">(</span><span class="s">&quot;spam&quot;</span><span class="n">_a</span><span class="o">=</span><span class="n">py</span><span class="o">::</span><span class="n">none</span><span class="p">(),</span><span class="s">&quot;eggs&quot;</span><span class="n">_a</span><span class="o">=</span><span class="mi">42</span><span class="p">);</span>
</pre></div>
</div>
<p>Python的元组对像可以命名用<code class="docutils literal notranslate"><span class="pre">py::make_tuple()</span></code>来实例化。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">py</span><span class="p">::</span><span class="nb">tuple</span> <span class="n">tup</span><span class="o">=</span><span class="n">py</span><span class="p">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span><span class="n">py</span><span class="p">::</span><span class="n">none</span><span class="p">(),</span><span class="s2">&quot;spame&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>来回转换</p>
<p>使用<code class="docutils literal notranslate"><span class="pre">py::cast()</span></code>将C++类型转换为Python类型。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">MyClass</span><span class="w"> </span><span class="o">*</span><span class="n">cls</span><span class="o">=</span><span class="p">...;</span>
<span class="n">py</span><span class="o">::</span><span class="n">object</span><span class="w"> </span><span class="n">obj</span><span class="o">=</span><span class="n">py</span><span class="o">::</span><span class="n">cast</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
</pre></div>
</div>
<p>反向转换如下，</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">::</span><span class="n">object</span><span class="w"> </span><span class="n">obj</span><span class="o">=</span><span class="p">...;</span>
<span class="n">MyClass</span><span class="w"> </span><span class="o">*</span><span class="n">cls</span><span class="o">=</span><span class="n">obj</span><span class="p">.</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">();</span>
</pre></div>
</div>
</li>
<li><p>C++访问Python库</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Equivalent to &quot;from decial import Decimal&quot;</span>
<span class="n">py</span><span class="o">::</span><span class="n">object</span><span class="w"> </span><span class="n">Decimal</span><span class="o">=</span><span class="n">py</span><span class="o">::</span><span class="n">module_</span><span class="o">::</span><span class="k">import</span><span class="p">(</span><span class="s">&quot;decimal&quot;</span><span class="p">).</span><span class="n">attr</span><span class="p">(</span><span class="s">&quot;Decimal&quot;</span><span class="p">);</span>
<span class="c1">// Try to import scipy</span>
<span class="n">py</span><span class="o">::</span><span class="n">object</span><span class="w"> </span><span class="n">scipy</span><span class="o">=</span><span class="n">py</span><span class="o">::</span><span class="n">module_</span><span class="o">::</span><span class="k">import</span><span class="p">(</span><span class="s">&quot;scipy&quot;</span><span class="p">);</span>
<span class="k">return</span><span class="w"> </span><span class="n">scipy</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">&quot;__version__&quot;</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>C++调用Python函数</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Construct a Python object of class Decimal</span>
<span class="n">py</span><span class="o">::</span><span class="n">object</span><span class="w"> </span><span class="n">pi</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;3.14159&quot;</span><span class="p">);</span>
<span class="c1">// Use Python to make our directories</span>
<span class="n">py</span><span class="o">::</span><span class="n">object</span><span class="w"> </span><span class="n">os</span><span class="o">=</span><span class="n">py</span><span class="o">::</span><span class="n">module_</span><span class="o">::</span><span class="k">import</span><span class="p">(</span><span class="s">&quot;os&quot;</span><span class="p">);</span>
<span class="n">py</span><span class="o">::</span><span class="n">object</span><span class="w"> </span><span class="n">makedirs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">&quot;makedirs&quot;</span><span class="p">);</span>
<span class="n">makedirs</span><span class="p">(</span><span class="s">&quot;/tmp/path/to/somewhere&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>如果类型转换或<code class="docutils literal notranslate"><span class="pre">py::class_</span></code>已定义，则可以将Python获得的计算结果转换为C++类型。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">::</span><span class="n">function</span><span class="w"> </span><span class="n">f</span><span class="o">=</span><span class="p">...;</span>
<span class="n">py</span><span class="o">::</span><span class="n">object</span><span class="w"> </span><span class="n">result_py</span><span class="o">=</span><span class="n">f</span><span class="p">(</span><span class="mi">123</span><span class="p">,</span><span class="s">&quot;bac&quot;</span><span class="p">,</span><span class="n">some_instance</span><span class="p">);</span>
<span class="n">MyClass</span><span class="w"> </span><span class="o">&amp;</span><span class="n">result</span><span class="o">=</span><span class="n">result_py</span><span class="p">.</span><span class="n">cast</span><span class="o">&lt;</span><span class="n">MyClass</span><span class="o">&gt;</span><span class="p">();</span><span class="w">	</span>
</pre></div>
</div>
</li>
<li><p>参数关键字</p>
<p>如下Python的调用语法，</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">say</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
	<span class="o">...</span> <span class="c1"># function code</span>
<span class="n">f</span><span class="p">(</span><span class="mi">123</span><span class="p">,</span> <span class="n">say</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="n">some_instance</span><span class="p">)</span> <span class="c1"># keyword call in Python</span>
</pre></div>
</div>
<p>在C++中，可以通过以下代码等效调用，</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">pybind11</span><span class="o">::</span><span class="nn">literals</span><span class="p">;</span><span class="w">  </span><span class="c1">//to bring in the  _a literal</span>
<span class="n">f</span><span class="p">(</span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;say&quot;</span><span class="n">_a</span><span class="o">=</span><span class="s">&quot;hello&quot;</span><span class="p">,</span><span class="s">&quot;to&quot;</span><span class="n">_a</span><span class="o">=</span><span class="n">some_instance</span><span class="p">);</span><span class="w"> </span><span class="c1">//keyword call in C++</span>
</pre></div>
</div>
</li>
<li><p>参数拆箱</p>
<p><code class="docutils literal notranslate"><span class="pre">*args,</span> <span class="pre">**kwargs</span></code>参数拆开同样是可行的，并且可以和其它参数混合。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// * unpacking</span>
<span class="n">py</span><span class="o">::</span><span class="n">tuple</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="n">py</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="mi">1234</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">some_instance</span><span class="p">);</span>
<span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span>

<span class="c1">// ** unpacking</span>
<span class="n">py</span><span class="o">::</span><span class="n">dict</span><span class="w"> </span><span class="n">kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">dict</span><span class="p">(</span><span class="s">&quot;number&quot;</span><span class="n">_a</span><span class="o">=</span><span class="mi">1234</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;say&quot;</span><span class="n">_a</span><span class="o">=</span><span class="s">&quot;hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;to&quot;</span><span class="n">_a</span><span class="o">=</span><span class="n">some_instance</span><span class="p">);</span>
<span class="n">f</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">);</span>

<span class="c1">// mixed keywords, * and ** unpacking</span>
<span class="n">py</span><span class="o">::</span><span class="n">tuple</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="mi">1234</span><span class="p">);</span>
<span class="n">py</span><span class="o">::</span><span class="n">dict</span><span class="w"> </span><span class="n">kwargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">dict</span><span class="p">(</span><span class="s">&quot;to&quot;</span><span class="n">_a</span><span class="o">=</span><span class="n">some_instance</span><span class="p">);</span>
<span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;say&quot;</span><span class="n">_a</span><span class="o">=</span><span class="s">&quot;hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>隐式转换</p>
<p>当使用Python类型的C++接口，或调用Python函数，一般返回的是<code class="docutils literal notranslate"><span class="pre">object</span></code>类型的对象。可以隐式转换为子类型，如<code class="docutils literal notranslate"><span class="pre">dict</span></code>。这与代理对象的<code class="docutils literal notranslate"><span class="pre">operator[]</span></code>或<code class="docutils literal notranslate"><span class="pre">obj.attr()</span></code>返回结果是等效的。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pybind11/numpy.h&gt;</span>
<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">pybind11</span><span class="o">::</span><span class="nn">literals</span><span class="p">;</span>

<span class="n">py</span><span class="o">::</span><span class="n">module_</span><span class="w"> </span><span class="n">os</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">module_</span><span class="o">::</span><span class="k">import</span><span class="p">(</span><span class="s">&quot;os&quot;</span><span class="p">);</span>
<span class="n">py</span><span class="o">::</span><span class="n">module_</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">module_</span><span class="o">::</span><span class="k">import</span><span class="p">(</span><span class="s">&quot;os.path&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// like &#39;import os.path as path&#39;</span>
<span class="n">py</span><span class="o">::</span><span class="n">module_</span><span class="w"> </span><span class="n">np</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">module_</span><span class="o">::</span><span class="k">import</span><span class="p">(</span><span class="s">&quot;numpy&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// like &#39;import numpy as np&#39;</span>

<span class="n">py</span><span class="o">::</span><span class="n">str</span><span class="w"> </span><span class="n">curdir_abs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">&quot;abspath&quot;</span><span class="p">)(</span><span class="n">path</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">&quot;curdir&quot;</span><span class="p">));</span>
<span class="n">py</span><span class="o">::</span><span class="n">print</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;Current directory: &quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">curdir_abs</span><span class="p">);</span>
<span class="n">py</span><span class="o">::</span><span class="n">dict</span><span class="w"> </span><span class="n">environ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">os</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">&quot;environ&quot;</span><span class="p">);</span>
<span class="n">py</span><span class="o">::</span><span class="n">print</span><span class="p">(</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;HOME&quot;</span><span class="p">]);</span>
<span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">attr</span><span class="p">(</span><span class="s">&quot;ones&quot;</span><span class="p">)(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;dtype&quot;</span><span class="n">_a</span><span class="o">=</span><span class="s">&quot;float32&quot;</span><span class="p">);</span>
<span class="n">py</span><span class="o">::</span><span class="n">print</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">repr</span><span class="p">(</span><span class="n">arr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">int_</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="numpy">
<h3><span class="section-number">1.4.2. </span>Numpy<a class="headerlink" href="#numpy" title="此标题的永久链接"></a></h3>
<ol class="arabic">
<li><p>Python缓冲协议buffer_protocol</p>
<p>Python 中可用的某些对象封装了对底层内存数组或缓冲区的访问。这类对象包含内建的<code class="docutils literal notranslate"><span class="pre">bytes</span></code>和<code class="docutils literal notranslate"><span class="pre">bytearray</span></code>以及一些扩展的类型如<code class="docutils literal notranslate"><span class="pre">array.array</span></code>。第三方库为了某些目标，或许也定义了它们自有类型，例如图像处理或数值分析。尽管这些类型都有它们自已的语法，但都一个共同的特征，即背后可能都有一个非常大的内存缓冲区。在某些情况下，希望直接访问缓冲区，而无需中间复制。Python在C级别以缓冲区协议的形式提供了这样的工具。该协议<code class="docutils literal notranslate"><span class="pre">buffer_protocl</span></code>主要有如下接口：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">buffer_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
<span class="w">  </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">itemsize</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">format</span><span class="p">;</span>
<span class="w">  </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">ndim</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">ssize_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">shape</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">ssize_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">strides</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>支持<code class="docutils literal notranslate"><span class="pre">buffer_protocol</span></code>，一个新类型需要在<code class="docutils literal notranslate"><span class="pre">py::class_</span></code>构造函数指定一个特殊的标记<code class="docutils literal notranslate"><span class="pre">py::buffer_protocol</span></code>并且调用方法<code class="docutils literal notranslate"><span class="pre">def_buffer()</span></code>使用lambda函数创建一个<code class="docutils literal notranslate"><span class="pre">py::buffer_info</span></code>描述。</p>
</li>
<li><p>例如有以下新类型<code class="docutils literal notranslate"><span class="pre">Matrix</span></code>，</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Matrix</span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">	</span><span class="n">Matrix</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">cols</span><span class="p">)</span><span class="o">:</span><span class="n">m_rows</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span><span class="n">m_cols</span><span class="p">(</span><span class="n">cols</span><span class="p">){</span>
<span class="w">		</span><span class="n">m_data</span><span class="o">=</span><span class="k">new</span><span class="w"> </span><span class="kt">float</span><span class="p">[</span><span class="n">rows</span><span class="o">*</span><span class="n">cols</span><span class="p">];</span>
<span class="w">	</span><span class="p">}</span>
<span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">m_data</span><span class="p">;}</span>
<span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">rows</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">m_rows</span><span class="p">;}</span>
<span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">cols</span><span class="p">()</span><span class="w"> </span><span class="n">oonst</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">m_cols</span><span class="p">;}</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">	</span><span class="kt">size_t</span><span class="w"> </span><span class="n">m_rows</span><span class="p">,</span><span class="n">m_cols</span><span class="p">;</span>
<span class="w">	</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">m_data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>下面的绑定代码导出<code class="docutils literal notranslate"><span class="pre">Matrix</span></code>的内容作为一个缓冲对象，可以将Matrix转换为Numpy数组。甚至可以避免复制操作类似<code class="docutils literal notranslate"><span class="pre">np.array(matrix_instance,</span> <span class="pre">copy=false)</span></code>。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Matrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">buffer_protocol</span><span class="p">())</span>
<span class="w">	</span><span class="p">.</span><span class="n">def_buffer</span><span class="p">([](</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">py</span><span class="o">::</span><span class="n">buffer_info</span><span class="p">{</span>
<span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">buffer_info</span><span class="p">{</span>
<span class="w">		</span><span class="n">m</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w">   </span><span class="c1">//pointer to buffer</span>
<span class="w">		</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">),</span><span class="w"> </span><span class="c1">//size of one scalar</span>
<span class="w">		</span><span class="n">py</span><span class="o">::</span><span class="n">format_descriptor</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;::</span><span class="n">format</span><span class="p">(),</span><span class="w"> </span><span class="c1">//pythonstruct-style format descriptor</span>
<span class="w">		</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="c1">//number of dimensions</span>
<span class="w">		</span><span class="p">{</span><span class="n">m</span><span class="p">.</span><span class="n">rows</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">cols</span><span class="p">()},</span><span class="w"> </span><span class="c1">//buffer dimensions</span>
<span class="w">		</span><span class="p">{</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="o">*</span><span class="n">m</span><span class="p">.</span><span class="n">cols</span><span class="p">(),</span><span class="w"> </span><span class="c1">//strides (in bytes) for each index</span>
<span class="w">		 </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">)}</span>
<span class="w">		</span><span class="p">};</span>
<span class="w">	</span><span class="p">});</span>
</pre></div>
</div>
</li>
<li><p>要创建一个可以将 Python 缓冲区对象作为参数的 C++ 函数，只需使用类型 py::buffer 作为其参数之一。缓冲区可以存在于多种配置中，因此在函数体中通常需要进行一些安全检查。下面，可以看到一个关于如何为 Eigen 双精度矩阵 (Eigen::MatrixXd) 类型定义自定义构造函数的基本示例，该类型支持从兼容的缓冲区对象（例如 NumPy 矩阵）进行初始化。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Bind MatrixXd (or some other Eigen type) to Python */</span>
<span class="k">typedef</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">MatrixXd</span><span class="w"> </span><span class="n">Matrix</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="n">Matrix</span><span class="o">::</span><span class="n">Scalar</span><span class="w"> </span><span class="n">Scalar</span><span class="p">;</span>
<span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">rowMajor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Matrix</span><span class="o">::</span><span class="n">Flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">RowMajorBit</span><span class="p">;</span>

<span class="n">py</span><span class="o">::</span><span class="n">class_</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Matrix&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">buffer_protocol</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">init</span><span class="p">([](</span><span class="n">py</span><span class="o">::</span><span class="n">buffer</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">typedef</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Stride</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Dynamic</span><span class="p">,</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Dynamic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Strides</span><span class="p">;</span>

<span class="w">        </span><span class="cm">/* Request a buffer descriptor from Python */</span>
<span class="w">        </span><span class="n">py</span><span class="o">::</span><span class="n">buffer_info</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">request</span><span class="p">();</span>

<span class="w">        </span><span class="cm">/* Some sanity checks ... */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">format</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">format_descriptor</span><span class="o">&lt;</span><span class="n">Scalar</span><span class="o">&gt;::</span><span class="n">format</span><span class="p">())</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Incompatible format: expected a double array!&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">ndim</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Incompatible buffer dimension!&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">strides</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Strides</span><span class="p">(</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">strides</span><span class="p">[</span><span class="n">rowMajor</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Scalar</span><span class="p">),</span>
<span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">strides</span><span class="p">[</span><span class="n">rowMajor</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="kt">ssize_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Scalar</span><span class="p">));</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Matrix</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Strides</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Scalar</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">ptr</span><span class="p">),</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">strides</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Matrix</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
<span class="w">    </span><span class="p">}));</span>
</pre></div>
</div>
<p>作为参考，此 Eigen 数据类型的 def_buffer() 调用应如下所示：</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">.</span><span class="n">def_buffer</span><span class="p">([](</span><span class="n">Matrix</span><span class="w"> </span><span class="o">&amp;</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">buffer_info</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">buffer_info</span><span class="p">(</span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w">                                </span><span class="cm">/* Pointer to buffer */</span>
<span class="w">        </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Scalar</span><span class="p">),</span><span class="w">                          </span><span class="cm">/* Size of one scalar */</span>
<span class="w">        </span><span class="n">py</span><span class="o">::</span><span class="n">format_descriptor</span><span class="o">&lt;</span><span class="n">Scalar</span><span class="o">&gt;::</span><span class="n">format</span><span class="p">(),</span><span class="w"> </span><span class="cm">/* Python struct-style format descriptor */</span>
<span class="w">        </span><span class="mi">2</span><span class="p">,</span><span class="w">                                       </span><span class="cm">/* Number of dimensions */</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">rows</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">cols</span><span class="p">()</span><span class="w"> </span><span class="p">},</span><span class="w">                  </span><span class="cm">/* Buffer dimensions */</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Scalar</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">rowMajor</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">cols</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">          </span><span class="k">sizeof</span><span class="p">(</span><span class="n">Scalar</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">rowMajor</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">rows</span><span class="p">())</span><span class="w"> </span><span class="p">}</span>
<span class="w">                                                 </span><span class="cm">/* Strides (in bytes) for each index */</span>
<span class="w">    </span><span class="p">);</span>
<span class="w"> </span><span class="p">})</span>
</pre></div>
</div>
</li>
<li><p>直接访问</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pybind11/pybind11.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pybind11/numpy.h&gt;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">py</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">pybind11</span><span class="p">;</span>

<span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">add_arrays</span><span class="p">(</span><span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input1</span><span class="p">,</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">py</span><span class="o">::</span><span class="n">buffer_info</span><span class="w"> </span><span class="n">buf1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input1</span><span class="p">.</span><span class="n">request</span><span class="p">(),</span><span class="w"> </span><span class="n">buf2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input2</span><span class="p">.</span><span class="n">request</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buf1</span><span class="p">.</span><span class="n">ndim</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">buf2</span><span class="p">.</span><span class="n">ndim</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Number of dimensions must be one&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buf1</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">buf2</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Input shapes must match&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* No pointer is passed, so NumPy will allocate the buffer */</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">py</span><span class="o">::</span><span class="n">array_t</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buf1</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

<span class="w">    </span><span class="n">py</span><span class="o">::</span><span class="n">buffer_info</span><span class="w"> </span><span class="n">buf3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">request</span><span class="p">();</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ptr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">buf1</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ptr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">buf2</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ptr3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">(</span><span class="n">buf3</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">buf1</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="n">idx</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="n">ptr3</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr1</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ptr2</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">PYBIND11_MODULE</span><span class="p">(</span><span class="n">test</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">m</span><span class="p">.</span><span class="n">def</span><span class="p">(</span><span class="s">&quot;add_arrays&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">add_arrays</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Add two NumPy arrays&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="../qt/qt_basic.html" class="btn btn-neutral float-left" title="1. Qt Basic" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, SSPUIIP.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>